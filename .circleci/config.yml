version: 2.1

orbs:
  node: circleci/node@7.2.1

jobs:
  build_lint_test_node:
    parameters:
      node-version:
        type: string
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - node/install:
          node-version: << parameters.node-version >>
      - node/install-packages:
          pkg-manager: npm
      - run: npm run build
      - run: npm run lint
      - run: npm run test --if-present

  build_lint_test:
    docker:
      - image: cimg/base:current
    steps:
      - run: echo "All node version tests passed"

  release:
    docker:
      - image: cimg/base:current
    environment:
      CI: "true"
      HUSKY: "0"
    steps:
      - checkout
      - node/install:
          node-version: "22"
      - node/install-packages:
          pkg-manager: npm
      - run: npm run build
      - run:
          name: Semantic Release
          command: npx semantic-release
      - run:
          name: Create Release Assets PR
          command: |
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$VERSION" ] && git log -1 --format=%s | grep -q "chore(release)"; then
              PAYLOAD=$(jq -n \
                --arg title "chore(release): merge release ${VERSION} assets" \
                --arg head "release/${VERSION}" \
                --arg base "main" \
                --arg body "Merge release ${VERSION} assets" \
                '{title: $title, head: $head, base: $base, body: $body}')
              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/pulls" \
                -d "$PAYLOAD")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | head -n -1)
              if [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "422" ]; then
                echo "PR creation failed (HTTP $HTTP_CODE): $BODY"
                exit 1
              fi
              echo "PR creation response (HTTP $HTTP_CODE): $BODY"
            fi

workflows:
  ci:
    jobs:
      - build_lint_test_node:
          matrix:
            parameters:
              node-version: ["20", "22", "24"]
      - build_lint_test:
          requires:
            - build_lint_test_node
      - release:
          requires:
            - build_lint_test
          context: npm-publish
          filters:
            branches:
              only: main
