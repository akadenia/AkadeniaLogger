version: 2.1

orbs:
  node: circleci/node@7.2.1

jobs:
  build_lint_test:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - node/install
      - node/install-packages:
          pkg-manager: npm
      - run: npm run build
      - run: npm run lint
      - run: npm run test --if-present

  release:
    docker:
      - image: cimg/base:current
    environment:
      CI: "true"
      HUSKY: "0"
    steps:
      - checkout
      - node/install
      - node/install-packages:
          pkg-manager: npm
      - run: npm run build
      - run:
          name: Semantic Release
          command: npx semantic-release
      - run:
          name: Create Release Assets PR
          command: |
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$VERSION" ] && git log -1 --format=%s | grep -q "chore(release)"; then
              curl -s -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/pulls" \
                -d "{\"title\": \"chore(release): merge release $VERSION assets\", \"head\": \"release/$VERSION\", \"base\": \"main\", \"body\": \"Merge release $VERSION assets\"}" || true
            fi

workflows:
  ci:
    jobs:
      - build_lint_test
      - release:
          requires:
            - build_lint_test
          context: npm-publish
          filters:
            branches:
              only: main
