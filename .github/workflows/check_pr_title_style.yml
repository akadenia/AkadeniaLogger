name: "Check PR Title Style"
on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize

jobs:
  check-pr-title-style:
    name: Check pr title style
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          # Skip if WIP
          if [[ "$PR_TITLE" =~ ^\[WIP\] ]]; then
            echo "✅ WIP PR — skipping validation"
            exit 0
          fi

          # Skip if ignored labels
          for label in bot ignore-semantic-pull-request; do
            if [[ ",$PR_LABELS," == *",$label,"* ]]; then
              echo "✅ Label '$label' found — skipping validation"
              exit 0
            fi
          done

          # Validate conventional commit format: type(scope): subject
          PATTERN='^([a-zA-Z]+)\(([a-zA-Z0-9$.,\-*/ ]+)\): (.+)$'
          if [[ ! "$PR_TITLE" =~ $PATTERN ]]; then
            echo "❌ PR title must match: type(scope): subject"
            echo ""
            echo "   Got: $PR_TITLE"
            echo ""
            echo "   Examples:"
            echo "     feat(auth): add login page"
            echo "     fix(api): handle null response"
            echo "     ci(circleci): migrate to CircleCI"
            exit 1
          fi

          TYPE="${BASH_REMATCH[1]}"
          SCOPE="${BASH_REMATCH[2]}"
          SUBJECT="${BASH_REMATCH[3]}"

          # Validate type
          VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
          if [[ ! "$TYPE" =~ ^($VALID_TYPES)$ ]]; then
            echo "❌ Invalid type: '$TYPE'"
            echo "   Allowed: $VALID_TYPES"
            exit 1
          fi

          # Disallow 'core' scope
          if [[ "$SCOPE" == "core" ]]; then
            echo "❌ Scope 'core' is not allowed"
            exit 1
          fi

          # Validate subject characters
          SUBJECT_PATTERN='^[A-Za-z0-9 !@#$%^&*()\-_+=|{}\[\]:;"'\''<>,.?/~`]+$'
          if [[ ! "$SUBJECT" =~ $SUBJECT_PATTERN ]]; then
            echo "❌ Subject contains invalid characters: '$SUBJECT'"
            exit 1
          fi

          echo "✅ PR title is valid: $TYPE($SCOPE): $SUBJECT"
