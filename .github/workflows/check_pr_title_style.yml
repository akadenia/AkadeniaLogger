name: "Check PR Title Style"
on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize

jobs:
  check-pr-title-style:
    name: Check pr title style
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Validate PR title (Conventional Commits)
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Skip WIP PRs
          if echo "$PR_TITLE" | grep -qiE '^\[WIP\]'; then
            echo "WIP PR — skipping title check."
            exit 0
          fi

          # Allowed types (conventional commits)
          TYPES="build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test"

          # Rule: type(scope): subject
          #   - type    : one of the allowed types above
          #   - scope   : required, alphanumeric + hyphens/dots/slashes/spaces/$/*
          #   - subject : non-empty (any casing allowed)
          PATTERN="^($TYPES)\([-a-zA-Z0-9\$.*/ ]+\): .+$"

          if ! echo "$PR_TITLE" | grep -qE "$PATTERN"; then
            echo ""
            echo "❌ PR title does not follow Conventional Commits format."
            echo ""
            echo "   Title : \"$PR_TITLE\""
            echo ""
            echo "   Required format : type(scope): subject"
            echo "   Allowed types   : build, chore, ci, docs, feat, fix, perf, refactor, revert, style, test"
            echo "   Rules:"
            echo "     - scope is required"
            echo ""
            echo "   Examples:"
            echo "     ✅  feat(auth): add OAuth2 support"
            echo "     ✅  fix(api): Handle empty response body"
            echo "     ❌  feat: missing scope"
            exit 1
          fi

          # Disallow scope "core" (trim whitespace before comparing)
          SCOPE=$(echo "$PR_TITLE" | sed -E "s/^[a-z]+\(([^)]+)\):.*/\1/" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ "$SCOPE" = "core" ]; then
            echo ""
            echo "❌ The scope \"core\" is not allowed."
            echo "   Title : \"$PR_TITLE\""
            exit 1
          fi

          echo "✅ PR title is valid: \"$PR_TITLE\""
